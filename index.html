<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Simulador de empr√©stimos</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/modern-normalize/1.1.0/modern-normalize.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1"></script>
<style>
:root {
  --bg: #f7fafc;
  --text: #0f172a;
  --box: #ffffff;
  --border: #e2e8f0;
  --table-even: #f9fafb;
  --table-odd: #ffffff;
  --hover: #d1fae5;
  --summary-bg: #d1fae5;
}

body.dark {
  --bg: #0f172a;
  --text: #e2e8f0;
  --box: #1e293b;
  --border: #334155;
  --table-even: #1e293b;
  --table-odd: #172033;
  --hover: #134e4a;
  --summary-bg: #134e4a;
}

body {
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto;
  padding:18px;
  background:var(--bg);
  color:var(--text);
  transition: background .3s, color .3s;
}

h1 { margin:0 0 12px; font-size:20px; }

.box {
  background:var(--box);
  border-radius:8px;
  padding:14px;
  box-shadow:0 6px 18px rgba(2,6,23,0.06);
  margin-bottom:14px;
  border:1px solid var(--border);
  transition: background .3s;
}

.grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:10px; }

label { font-size:12px; display:block; margin-bottom:6px; }

input[type="number"], select {
  width:100%;
  padding:8px 10px;
  border:1px solid var(--border);
  border-radius:6px;
  font-size:14px;
  background:var(--box);
  color:var(--text);
}

button {
  background:#0ea5a4;
  color:white;
  padding:10px 12px;
  border:0;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
}

button.secondary { background:#64748b; margin-left:8px; }

table {
  width:100%;
  border-collapse:collapse;
  font-size:13px;
  margin-top:10px;
}

th, td {
  padding:8px 6px;
  border-bottom:1px solid var(--border);
  text-align:right;
}

th {
  background:var(--box);
  position:sticky;
  top:0;
  z-index:10;
  font-weight:700;
}

td.left, th.left { text-align:left; }

tbody tr:nth-child(even) { background-color:var(--table-even); }
tbody tr:nth-child(odd) { background-color:var(--table-odd); }
tbody tr:hover { background-color:var(--hover) !important; }

#summaryBox {
  flex:1;
  min-width:200px;
  background:var(--summary-bg);
  border-radius:8px;
  padding:16px;
  border:1px solid var(--border);
}

#tableWrap { overflow:auto; max-height:420px; position:relative; }

/* ===== Bot√£o Dark Mode ===== */

#themeToggle {
  position:fixed;
  top:16px;
  right:16px;
  width:42px;
  height:42px;
  border-radius:50%;
  border:none;
  background:var(--box);
  box-shadow:0 4px 12px rgba(0,0,0,0.2);
  cursor:pointer;
  font-size:18px;
  display:flex;
  align-items:center;
  justify-content:center;
  transition: all .3s;
  z-index:999;
}

#themeToggle:hover {
  transform:scale(1.1);
}
</style>

</head>
<body>
<button id="themeToggle" title="Alternar modo claro/escuro">üåô</button>

<h1>Simulador - Empr√©stimos com garantia em BTC</h1>

<div class="box">
  <div class="grid">
    <div><label>Plataforma</label>
      <select id="platform">
        <option value="Ledn">Ledn</option>
        <option value="Aave">Aave</option>
      </select>
    </div>
    <div><label>Pre√ßo BTC (USD) em jan/2026</label><input id="btcUsd" type="number" value="130000" step="100" /></div>
    <div><label>C√¢mbio (R$/USD)</label><input id="usdBrl" type="number" value="6" step="0.01" /></div>
    <div><label>Valoriza√ß√£o BTC (ano %)</label><input id="btcGrowth" type="number" value="25" step="0.1" /></div>
    <div><label>Sal√°rio/aporte convertido mensal (R$)</label><input id="monthlySalary" type="number" value="12000" step="100" /></div>
    <div><label>PLR (R$) ‚Äî janeiro de cada ano</label><input id="plr" type="number" value="10000" step="100" /></div>
    <div><label>Aporte √∫nico (R$)</label><input id="initialAporte" type="number" value="35000" step="100" /></div>
    <div><label>Saque l√≠quido mensal (R$)</label><input id="monthlyWithdraw" type="number" value="9000" step="100" /></div>
    <div><label>Juros anual (%)</label><input id="annualInterest" type="number" value="10" step="0.1" /></div>
    <div><label>Taxa administrativa anual (%)</label><input id="adminFee" type="number" value="2.4" step="0.1" /></div>
    <div><label>LTV alvo (%)</label><input id="ltv" type="number" value="50" step="1" /></div>
    <div><label>Reserva inicial (BTC)</label><input id="reserveBtc" type="number" value="0" step="0.000001" /></div>
    <div><label>Ano in√≠cio</label><input id="startYear" type="number" value="2026" /></div>
    <div><label>Ano fim</label><input id="endYear" type="number" value="2029" /></div>
  </div>

  <div style="margin-top:10px;">
  <button id="run">Simular</button>
  <button id="save" class="secondary">Salvar resultado</button>
  <button id="viewSaves" class="secondary">Ver salvos</button>
  <p>Atalho: ctrl+enter para executar simula√ß√£o.</p>
</div>

<!-- Modal simples para listar simula√ß√µes salvas -->
<div id="savedModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.4); align-items:center; justify-content:center;">
  <div style="background:white; padding:20px; border-radius:8px; width:90%; max-width:480px; max-height:80vh; overflow:auto;">
    <h3>Simula√ß√µes salvas</h3>
    <ul id="savedList" style="list-style:none; padding:0;"></ul>
    <button id="closeModal" style="margin-top:10px;">Fechar</button>
  </div>
</div>

  
</div>

<div class="box" id="chartSection">
  <div id="chartWrap"><canvas id="chart"></canvas></div>
  <div id="summaryBox">
    <h2>Resumo Final</h2>
    <div>Patrim√¥nio total: <span id="sumPatrimonio">-</span></div>
    <div>BTC total comprado: <span id="sumBTC">-</span></div>
	<div>BTC total (comprado + reserva): <span id="sumBTCTotal">-</span></div>
    <div>Reserva total utilizada: <span id="sumReserva">-</span></div>
    <div>D√≠vida total: <span id="sumDivida">-</span></div>
  </div>
</div>

<div class="box" id="tableWrap"></div>

<script>
function formatBRL(v){return v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});}
function formatNum(v,d=6){return Number.isFinite(v)?v.toFixed(d):'-';}

let rows=[];
let chart;

document.getElementById("platform").addEventListener("change", function() {
  const platform = this.value;
  if (platform === "Ledn") {
    document.getElementById("annualInterest").value = 10;
    document.getElementById("adminFee").value = 2.4;
  } else if (platform === "Aave") {
    document.getElementById("annualInterest").value = 6;
    document.getElementById("adminFee").value = 0;
  }
});


document.getElementById("run").addEventListener("click",runSim);

function runSim() {
  const platform = document.getElementById("platform").value;
  const btcUsd = +document.getElementById("btcUsd").value;
  const usdBrl = +document.getElementById("usdBrl").value;
  const btcGrowth = +document.getElementById("btcGrowth").value / 100;
  const monthlySalary = +document.getElementById("monthlySalary").value;
  const plr = +document.getElementById("plr").value;
  const initialAporte = +document.getElementById("initialAporte").value;
  const monthlyWithdraw = +document.getElementById("monthlyWithdraw").value;
  const annualInterest = +document.getElementById("annualInterest").value / 100;
  const adminFee = +document.getElementById("adminFee").value / 100;
  const ltvTarget = +document.getElementById("ltv").value / 100;
  let reserveBtc = +document.getElementById("reserveBtc").value;
  const startYear = +document.getElementById("startYear").value;
  const endYear = +document.getElementById("endYear").value;

  let btcPriceBrl = btcUsd * usdBrl;
  const monthlyRate = Math.pow(1 + annualInterest + adminFee, 1 / 12) - 1;
  const monthlyBtcGrowth = Math.pow(1 + btcGrowth, 1 / 12) - 1;

  rows = [];
  let btcTotal = 0, totalInvested = 0, debt = 0, firstMonth = true;
  let totalReservaUsada = 0;
  let totalBtcComprado = 0; // ‚úÖ novo acumulador

  for (let year = startYear; year <= endYear; year++) {
    for (let m = 1; m <= 12; m++) {
      if (!(year === startYear && m === 1)) btcPriceBrl *= (1 + monthlyBtcGrowth);

      let invest = monthlySalary;
      if (m === 1) invest += plr;
      if (firstMonth) invest += initialAporte;
      firstMonth = false;
      totalInvested += invest;

      const btcBought = invest / btcPriceBrl;
      btcTotal += btcBought;
      totalBtcComprado += btcBought; // ‚úÖ acumula apenas o comprado

      let loanTaken = 0, debtFinal = 0, collateralNeededBTC = 0, reserveUsed = 0;

      if (platform === "Ledn") {
        loanTaken = monthlyWithdraw + debt;
        debtFinal = loanTaken * (1 + monthlyRate);
        const collateralNeededBRL = loanTaken / ltvTarget;
        collateralNeededBTC = collateralNeededBRL / btcPriceBrl;

        if (btcTotal < collateralNeededBTC) {
          reserveUsed = Math.min(collateralNeededBTC - btcTotal, reserveBtc);
          reserveBtc -= reserveUsed;
          btcTotal += reserveUsed;
        }
        debt = debtFinal;
      } else if (platform === "Aave") {
        debt += monthlyWithdraw;
        debt *= (1 + monthlyRate);
        const collateralNeededBRL = debt / ltvTarget;
        collateralNeededBTC = collateralNeededBRL / btcPriceBrl;

        if (btcTotal < collateralNeededBTC) {
          reserveUsed = Math.min(collateralNeededBTC - btcTotal, reserveBtc);
          reserveBtc -= reserveUsed;
          btcTotal += reserveUsed;
        }
        debtFinal = debt;
      }

      totalReservaUsada += reserveUsed;
      const patrimonio = (btcTotal + reserveBtc) * btcPriceBrl;

      rows.push({
        date: `${String(m).padStart(2, "0")}/${year}`,
        btcPriceBrl, invest, totalInvested, btcBought, btcTotal,
        reserveUsed, reserveBtc, loanTaken: monthlyWithdraw, debtFinal,
        collateralNeededBTC, ltv: debtFinal / (btcTotal * btcPriceBrl),
        patrimonio
      });
    }
  }

// gerar tabela
  let html = `<table><thead><tr><th class="left">M√™s</th><th>Pre√ßo BTC (R$)</th><th>Investido</th><th>Total Investido</th><th>BTC comprado</th><th>BTC total</th><th>Reserva usada</th><th>Reserva restante</th><th>Saque</th><th>D√≠vida</th><th>Colateral (BTC)</th><th>LTV (%)</th></thead><tbody>`;
  rows.forEach(r=>{
    html += `<tr><td class="left">${r.date}</td><td>${formatBRL(r.btcPriceBrl)}</td><td>${formatBRL(r.invest)}</td><td>${formatBRL(r.totalInvested)}</td><td>${formatNum(r.btcBought)}</td><td>${formatNum(r.btcTotal)}</td><td>${formatNum(r.reserveUsed)}</td><td>${formatNum(r.reserveBtc)}</td><td>${formatBRL(r.loanTaken)}</td><td>${formatBRL(r.debtFinal)}</td><td>${formatNum(r.collateralNeededBTC)}</td><td>${(r.ltv*100).toFixed(2)}</td></tr>`;
  });
  html += "</tbody></table>";
  document.getElementById("tableWrap").innerHTML = html;

  // gerar gr√°fico
  const labels = rows.map(r=>r.date);
  const debtData = rows.map(r=>r.debtFinal);
  const patrimonioData = rows.map(r=>r.patrimonio);

  const annotations = {};
  labels.forEach((l,i)=>{
    if(l.startsWith("01/") && l!=="01/"+startYear){
      annotations["line"+i] = {
        type:'line',
        xMin:i,
        xMax:i,
        borderColor:'rgba(100,100,100,0.4)',
        borderWidth:1,
        label:{enabled:true,content:l.slice(3),position:'start',color:'#555',font:{size:10}}
      };
    }
  });

  if(chart) chart.destroy();
  const ctx = document.getElementById("chart").getContext("2d");
  chart = new Chart(ctx,{
    type:'line',
    data:{
      labels,
      datasets:[
        { label:'D√≠vida (R$)', data:debtData, yAxisID:'y2', borderColor:'red', fill:false, tension:0.15 },
        { label:'Patrim√¥nio (R$)', data:patrimonioData, yAxisID:'y2', borderColor:'blue', fill:false, tension:0.15 }
      ]
    },
    options:{
      responsive:true,
      interaction:{mode:'index',intersect:false},
      stacked:false,
      plugins:{ annotation:{annotations} },
      scales:{
        y2:{ type:'linear', position:'left', title:{display:true,text:'Reais (R$)'}, grid:{drawOnChartArea:true} }
      }
    }
  });

  // resumo final (corrigido)
  const last = rows[rows.length - 1];
  document.getElementById("sumPatrimonio").textContent = formatBRL(last.patrimonio);
  document.getElementById("sumBTC").textContent = formatNum(totalBtcComprado, 4) + " ‚Çø"; // ‚úÖ corrigido
  document.getElementById("sumReserva").textContent = formatNum(totalReservaUsada, 4) + " ‚Çø";
  document.getElementById("sumDivida").textContent = formatBRL(last.debtFinal);
  document.getElementById("sumBTCTotal").textContent = formatNum(last.btcTotal + last.reserveBtc, 4) + " ‚Çø";

}
// ‚úÖ Salvar resultado da simula√ß√£o
document.getElementById("save").addEventListener("click", function() {
  if (rows.length === 0) {
    alert("Nenhuma simula√ß√£o encontrada. Execute a simula√ß√£o primeiro.");
    return;
  }

  const last = rows[rows.length - 1];
  const simData = {
    id: Date.now(),
    date: new Date().toLocaleString(),
    platform: document.getElementById("platform").value,
    patrimonio: last.patrimonio,
    btcTotal: last.btcTotal,
    debtFinal: last.debtFinal,
    data: rows
  };

  let saves = JSON.parse(localStorage.getItem("simulacoes") || "[]");
  saves.push(simData);
  localStorage.setItem("simulacoes", JSON.stringify(saves));

  alert("Simula√ß√£o salva com sucesso!");
});

// ‚úÖ Ver simula√ß√µes salvas
document.getElementById("viewSaves").addEventListener("click", function() {
  const saves = JSON.parse(localStorage.getItem("simulacoes") || "[]");
  const list = document.getElementById("savedList");
  list.innerHTML = "";

  if (saves.length === 0) {
    list.innerHTML = "<li>Nenhuma simula√ß√£o salva.</li>";
  } else {
    saves.forEach(s => {
      const li = document.createElement("li");
      li.style.marginBottom = "10px";
      li.innerHTML = `
        <strong>${s.platform}</strong> ‚Äî ${s.date}<br>
        Patrim√¥nio: ${formatBRL(s.patrimonio)} | BTC: ${formatNum(s.btcTotal,4)} | D√≠vida: ${formatBRL(s.debtFinal)}<br>
        <button data-id="${s.id}" class="loadSaved">Carregar</button>
        <button data-id="${s.id}" class="deleteSaved" style="background:#dc2626;">Excluir</button>
      `;
      list.appendChild(li);
    });
  }

  document.getElementById("savedModal").style.display = "flex";
});

// ‚úÖ Fechar modal
document.getElementById("closeModal").addEventListener("click", function() {
  document.getElementById("savedModal").style.display = "none";
});

// ‚úÖ Carregar simula√ß√£o salva
document.getElementById("savedList").addEventListener("click", function(e) {
  if (e.target.classList.contains("loadSaved")) {
    const id = +e.target.dataset.id;
    const saves = JSON.parse(localStorage.getItem("simulacoes") || "[]");
    const sim = saves.find(s => s.id === id);
    if (sim) {
      rows = sim.data;
      document.getElementById("savedModal").style.display = "none";
      alert("Simula√ß√£o carregada!");
      // Recria tabela e gr√°fico
      rebuildFromRows();
    }
  } else if (e.target.classList.contains("deleteSaved")) {
    const id = +e.target.dataset.id;
    let saves = JSON.parse(localStorage.getItem("simulacoes") || "[]");
    saves = saves.filter(s => s.id !== id);
    localStorage.setItem("simulacoes", JSON.stringify(saves));
    e.target.parentElement.remove();
  }
});

// ‚úÖ Fun√ß√£o auxiliar para reconstruir gr√°fico/tabela ao carregar simula√ß√£o
function rebuildFromRows() {
  let html = `<table><thead><tr><th class="left">M√™s</th><th>Pre√ßo BTC (R$)</th><th>Investido</th><th>Total Investido</th><th>BTC comprado</th><th>BTC total</th><th>Reserva usada</th><th>Reserva restante</th><th>Saque</th><th>D√≠vida</th><th>Colateral (BTC)</th><th>LTV (%)</th></thead><tbody>`;
  rows.forEach(r=>{
    html += `<tr><td class="left">${r.date}</td><td>${formatBRL(r.btcPriceBrl)}</td><td>${formatBRL(r.invest)}</td><td>${formatBRL(r.totalInvested)}</td><td>${formatNum(r.btcBought)}</td><td>${formatNum(r.btcTotal)}</td><td>${formatNum(r.reserveUsed)}</td><td>${formatNum(r.reserveBtc)}</td><td>${formatBRL(r.loanTaken)}</td><td>${formatBRL(r.debtFinal)}</td><td>${formatNum(r.collateralNeededBTC)}</td><td>${(r.ltv*100).toFixed(2)}</td></tr>`;
  });
  html += "</tbody></table>";
  document.getElementById("tableWrap").innerHTML = html;

  const labels = rows.map(r=>r.date);
  const debtData = rows.map(r=>r.debtFinal);
  const patrimonioData = rows.map(r=>r.patrimonio);

  if(chart) chart.destroy();
  const ctx = document.getElementById("chart").getContext("2d");
  chart = new Chart(ctx,{
    type:'line',
    data:{
      labels,
      datasets:[
        { label:'D√≠vida (R$)', data:debtData, yAxisID:'y2', borderColor:'red', fill:false, tension:0.15 },
        { label:'Patrim√¥nio (R$)', data:patrimonioData, yAxisID:'y2', borderColor:'blue', fill:false, tension:0.15 }
      ]
    },
    options:{
      responsive:true,
      interaction:{mode:'index',intersect:false},
      stacked:false,
      scales:{
        y2:{ type:'linear', position:'left', title:{display:true,text:'Reais (R$)'} }
      }
    }
  });

  const last = rows[rows.length - 1];
  document.getElementById("sumPatrimonio").textContent = formatBRL(last.patrimonio);
  document.getElementById("sumBTC").textContent = formatNum(last.btcTotal, 4) + " ‚Çø";
  document.getElementById("sumReserva").textContent = formatNum(last.reserveUsed, 4) + " ‚Çø";
  document.getElementById("sumDivida").textContent = formatBRL(last.debtFinal);
  document.getElementById("sumBTCTotal").textContent = formatNum(last.btcTotal + last.reserveBtc, 4) + " ‚Çø";
}

// ‚úÖ Executar simula√ß√£o com Ctrl + Enter
document.addEventListener("keydown", function (event) {
  if (event.ctrlKey && event.key === "Enter") {
    event.preventDefault();
    runSim();
  }
});

// Executar simula√ß√£o com Ctrl + Enter
document.addEventListener("keydown", function (event) {
  if (event.ctrlKey && event.key === "Enter") {
    event.preventDefault(); // evita comportamentos inesperados
    runSim();
  }
});
// =======================
// DARK MODE
// =======================

const themeToggle = document.getElementById("themeToggle");
const prefersDark = window.matchMedia("(prefers-color-scheme: dark)");

function setTheme(mode) {
  if (mode === "dark") {
    document.body.classList.add("dark");
    themeToggle.textContent = "‚òÄÔ∏è";
  } else {
    document.body.classList.remove("dark");
    themeToggle.textContent = "üåô";
  }
  localStorage.setItem("theme", mode);
  updateChartTheme();
}

// Detectar sistema automaticamente (se n√£o tiver salvo)
const savedTheme = localStorage.getItem("theme");

if (savedTheme) {
  setTheme(savedTheme);
} else {
  setTheme(prefersDark.matches ? "dark" : "light");
}

// Se sistema mudar automaticamente
prefersDark.addEventListener("change", e => {
  if (!localStorage.getItem("theme")) {
    setTheme(e.matches ? "dark" : "light");
  }
});

themeToggle.addEventListener("click", () => {
  const isDark = document.body.classList.contains("dark");
  setTheme(isDark ? "light" : "dark");
});

// =======================
// Atualizar gr√°fico no dark
// =======================

function updateChartTheme() {
  if (!chart) return;

  const isDark = document.body.classList.contains("dark");

  chart.options.scales.y2.ticks = {
    color: isDark ? "#e2e8f0" : "#0f172a"
  };

  chart.options.plugins.legend = {
    labels: {
      color: isDark ? "#e2e8f0" : "#0f172a"
    }
  };

  chart.update();
}

</script>
</body>
</html>
